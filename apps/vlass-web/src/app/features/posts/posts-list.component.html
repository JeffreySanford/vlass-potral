<div class="posts-page">
  <mat-toolbar color="primary" class="posts-toolbar">
    <mat-icon>menu_book</mat-icon>
    <span>Community Research Notebook</span>
    <span class="spacer"></span>
    <button mat-button type="button" (click)="createDraft()">
      <mat-icon>add_circle</mat-icon>
      New Draft
    </button>
    <a mat-button routerLink="/landing">
      <mat-icon>home</mat-icon>
      Home
    </a>
  </mat-toolbar>

  <section class="posts-content">
    <section class="list-controls">
      <mat-form-field appearance="outline">
        <mat-label>Sort by</mat-label>
        <select matNativeControl [(ngModel)]="sortBy" [ngModelOptions]="{ standalone: true }">
          <option value="recent">Recent</option>
          <option value="author">Author</option>
          <option value="title">Title</option>
        </select>
      </mat-form-field>
      <label class="mine-filter">
        <input type="checkbox" [(ngModel)]="onlyMine" [ngModelOptions]="{ standalone: true }" />
        My posts only
      </label>
    </section>

    @if (loading) {
      <p>Loading published posts...</p>
    } @else if (errorMessage) {
      <p class="error">{{ errorMessage }}</p>
    } @else if (visiblePosts.length === 0) {
      <div class="empty-state">
        <h3>Welcome to the Notebook</h3>
        <p>No posts match this view yet. Start by drafting your first discovery.</p>
        <button mat-flat-button color="accent" type="button" (click)="createDraft()">Create a Draft</button>
      </div>
    } @else {
      <div class="post-grid">
        @for (post of visiblePosts; track post.id) {
          <mat-card class="post-card">
            <mat-card-header>
              <mat-card-title>
                <span class="status-badge" [class.draft]="post.status === 'draft'" [class.published]="post.status === 'published'">
                  {{ post.status }}
                </span>
                {{ post.title }}
              </mat-card-title>
              <mat-card-subtitle>
                @if (post.user?.username) {
                  <a [routerLink]="['/profile', post.user?.username]" (click)="$event.stopPropagation()" class="author-link">
                    {{ authorName(post) }}
                  </a>
                } @else {
                  <span class="author-link">{{ authorName(post) }}</span>
                }
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <p>Updated: {{ post.updated_at | date: 'medium' }}</p>
              <p>Published: {{ post.published_at ? (post.published_at | date: 'mediumDate') : 'n/a' }}</p>
              <p class="excerpt">{{ excerpt(post) }}</p>
            </mat-card-content>
            <mat-card-actions>
              <button mat-button type="button" (click)="openPost(post)">Open</button>
            </mat-card-actions>
          </mat-card>
        }
      </div>
    }
  </section>
</div>
