<div class="viewer-container">
  <mat-toolbar color="primary" class="viewer-toolbar">
    <span class="brand">Mode A Viewer</span>
    <span class="spacer"></span>
    <mat-form-field appearance="outline" class="target-search">
      <mat-label>Search target</mat-label>
      <input
        matInput
        type="text"
        spellcheck="false"
        [(ngModel)]="targetQuery"
        [ngModelOptions]="{ standalone: true }"
        (keyup.enter)="searchTarget()" />
      <button mat-icon-button matSuffix type="button" aria-label="Search" (click)="searchTarget()">
        <mat-icon>search</mat-icon>
      </button>
    </mat-form-field>
    <a mat-flat-button routerLink="/landing">Back to landing</a>
  </mat-toolbar>

  <div class="viewer-shell">
    <section class="viewer-canvas-panel">
      <div class="aladin-stage">
        <div #aladinHost class="aladin-host" aria-label="Aladin sky viewer" (mousemove)="onCanvasMouseMove($event)" (mouseleave)="onCanvasMouseLeave()"></div>
        <div class="center-indicator" aria-hidden="true">
          <span class="crosshair"></span>
          @if (centerCatalogLabel) {
            <span class="center-label">
              {{ centerCatalogLabel.name }} ({{ centerCatalogLabel.object_type }})
            </span>
          }
        </div>
        <div class="viewer-overlay-controls">
          <mat-slide-toggle
            [checked]="gridOverlayEnabled"
            (change)="toggleGridOverlay($any($event).checked)"
            color="primary">
            Grid
          </mat-slide-toggle>
          <mat-slide-toggle
            [checked]="labelsOverlayEnabled"
            (change)="toggleLabelsOverlay($any($event).checked)"
            color="primary">
            Labels
          </mat-slide-toggle>
          <mat-slide-toggle
            [checked]="pdssColorEnabled"
            (change)="togglePdssColor($any($event).checked)"
            color="accent">
            P/DSS2 Color
          </mat-slide-toggle>
        </div>
      </div>
      @if (nativeResolutionHint) {
        <div class="resolution-hint">
          <span>{{ nativeResolutionHint }}</span>
          @if (suggestedSharperSurvey) {
            <button mat-button type="button" (click)="applySuggestedSurvey()">Use {{ suggestedSharperSurvey }}</button>
          }
        </div>
      }
    </section>

    <mat-card class="viewer-state-card">
      <mat-card-header>
        <div class="card-title-wrap">
          <h1>Control Deck</h1>
          <p>Coordinate controls, sharing, cutouts, and annotations.</p>
        </div>
      </mat-card-header>
      <mat-card-content>
        <section class="panel-group">
          <form [formGroup]="stateForm" class="state-form">
            <mat-form-field appearance="outline">
              <mat-label>Right Ascension</mat-label>
              <input matInput type="number" formControlName="ra" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Declination</mat-label>
              <input matInput type="number" formControlName="dec" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Field of View</mat-label>
              <input matInput type="number" formControlName="fov" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Survey</mat-label>
              <select matNativeControl formControlName="survey">
                @for (option of surveyOptions; track option.value) {
                  <option [value]="option.value">{{ option.label }}</option>
                }
              </select>
            </mat-form-field>
          </form>
        </section>

        <section class="panel-group">
          <div class="actions">
            <button mat-stroked-button type="button" (click)="applyStateToUrl()">Update URL State</button>
            <button mat-stroked-button type="button" (click)="downloadScienceData()">Download FITS Cutout</button>
            <button mat-stroked-button type="button" (click)="createPermalink()" [disabled]="loadingPermalink">
              @if (loadingPermalink) {
                Creating permalink...
              } @else {
                Create Permalink
              }
            </button>
            <button mat-flat-button color="accent" type="button" (click)="saveSnapshot()" [disabled]="savingSnapshot">
              @if (savingSnapshot) {
                Saving snapshot...
              } @else {
                Save PNG Snapshot
              }
            </button>
          </div>
        </section>

        <section class="panel-group">
          <div class="label-tools">
            <mat-form-field appearance="outline" class="label-name-field">
              <mat-label>Center Label</mat-label>
              <input matInput type="text" [(ngModel)]="labelDraft" [ngModelOptions]="{ standalone: true }" />
            </mat-form-field>
            <button mat-stroked-button type="button" (click)="addCenterLabel()">Label Center</button>
          </div>
        </section>

        <details class="details-panel" open>
          <summary>Annotations</summary>
          @if (catalogLabels.length > 0) {
            <div class="catalog-labels">
              <h3>Catalog Labels Near Center</h3>
              @if (centerCatalogLabel) {
                <button mat-stroked-button type="button" (click)="addCenterCatalogLabelAsAnnotation()">
                  Annotate Center Match
                </button>
              }
              @for (label of catalogLabels; track label.name + label.ra + label.dec) {
                <div class="catalog-row" (mouseenter)="logCatalogHover(label)">
                  <span>{{ label.name }} ({{ label.object_type }}) - {{ label.angular_distance_deg.toFixed(3) }} deg</span>
                  <button mat-button type="button" (click)="addCatalogLabelAsAnnotation(label)">Annotate</button>
                </div>
              }
            </div>
          }

          @if (labels.length > 0) {
            <div class="label-list">
              <h3>Manual Annotations</h3>
              @for (label of labels; track label.created_at + label.name) {
                <div class="label-row">
                  <span>{{ label.name }} (RA {{ label.ra }}, Dec {{ label.dec }})</span>
                  <button mat-button type="button" (click)="removeLabel(label)">Remove</button>
                </div>
              }
            </div>
          }
        </details>

        <details class="details-panel">
          <summary>Cutout Detail & Diagnostics</summary>
          <div class="cutout-controls">
            <label class="cutout-label" for="cutout-detail">Cutout Detail</label>
            <select id="cutout-detail" [(ngModel)]="cutoutDetail" [ngModelOptions]="{ standalone: true }">
              <option value="standard">Standard (1024 px)</option>
              <option value="high">High (2048 px)</option>
              <option value="max">Max (3072 px)</option>
            </select>
          </div>

          @if (cutoutTelemetry) {
            <div class="telemetry-card">
              <h3>Cutout Telemetry</h3>
              <p>Success Rate: {{ cutoutSuccessRate }}</p>
              <p>Requests: {{ cutoutTelemetry.requests_total }} | Failures: {{ cutoutTelemetry.failure_total }}</p>
              <p>
                Fallbacks: res {{ cutoutTelemetry.resolution_fallback_total }} | survey
                {{ cutoutTelemetry.survey_fallback_total }}
              </p>
              <p>Cache Hits: {{ cutoutTelemetry.cache_hits_total }} | Attempts: {{ cutoutTelemetry.provider_attempts_total }}</p>
              @if (cutoutTelemetry.last_failure_reason) {
                <p class="status">Last Failure: {{ cutoutTelemetry.last_failure_reason }}</p>
              }
            </div>
          }
        </details>

        <details class="details-panel">
          <summary>Encoded State & Link Metadata</summary>
          <div class="meta">
            <p><strong>Encoded:</strong> {{ encodedState || 'n/a' }}</p>
            <p><strong>Short ID:</strong> {{ shortId || 'n/a' }}</p>
            <p><strong>Permalink:</strong> {{ permalink || 'n/a' }}</p>
          </div>
        </details>

        @if (statusMessage) {
          <p class="status status-block">{{ statusMessage }}</p>
        }
      </mat-card-content>
    </mat-card>
  </div>
</div>
