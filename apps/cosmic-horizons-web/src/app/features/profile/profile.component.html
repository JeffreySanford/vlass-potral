<div class="profile-page">
  <mat-toolbar color="primary" class="profile-toolbar">
    <mat-icon>account_box</mat-icon>
    <span>Researcher Profile</span>
    <span class="spacer"></span>
    @if (isOwner && !editing) {
      <button mat-button type="button" (click)="startEdit()">
        <mat-icon>edit</mat-icon>
        Edit Profile
      </button>
    }
    <a mat-button routerLink="/posts">
      <mat-icon>forum</mat-icon>
      Community
    </a>
  </mat-toolbar>

  <section class="profile-shell">
    @if (loading) {
      <p>Loading profile...</p>
    } @else if (error) {
      <mat-card class="error-card">
        <mat-card-content>{{ error }}</mat-card-content>
        <mat-card-actions>
          <a mat-button routerLink="/posts">Return to feed</a>
        </mat-card-actions>
      </mat-card>
    } @else if (profile) {
      <div class="profile-grid">
        <mat-card class="user-info-card">
          <mat-card-header>
            <div mat-card-avatar class="avatar-placeholder">
              @if (profile.user.avatar_url) {
                <img [src]="profile.user.avatar_url" alt="avatar">
              } @else {
                <mat-icon>account_circle</mat-icon>
              }
            </div>
            <mat-card-title>{{ profile.user.display_name || profile.user.username }}</mat-card-title>
            <mat-card-subtitle>@{{ profile.user.username }}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            @if (editing && isOwner) {
              <form class="profile-form" [formGroup]="editForm" (ngSubmit)="saveProfile()">
                <mat-form-field appearance="outline">
                  <mat-label>Display Name</mat-label>
                  <input matInput formControlName="display_name" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Bio</mat-label>
                  <textarea matInput rows="4" formControlName="bio"></textarea>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Avatar URL</mat-label>
                  <input matInput formControlName="avatar_url" placeholder="https://..." />
                </mat-form-field>

                <div class="profile-form-actions">
                  <button mat-stroked-button type="button" (click)="cancelEdit()" [disabled]="saving">
                    Cancel
                  </button>
                  <button mat-flat-button color="primary" type="submit" [disabled]="saving">
                    @if (saving) {
                      Saving...
                    } @else {
                      Save
                    }
                  </button>
                </div>
              </form>
            } @else {
              <p class="bio" [class.empty]="!profile.user.bio">
                {{ profile.user.bio || 'This researcher has not provided a biographical statement yet.' }}
              </p>
              <div class="meta">
                <mat-icon>calendar_today</mat-icon>
                <span>Member since {{ profile.user.created_at | date: 'MMMM yyyy' }}</span>
              </div>
            }
            @if (saveMessage) {
              <p class="save-message">{{ saveMessage }}</p>
            }
          </mat-card-content>
        </mat-card>

        <section class="user-posts">
          <h3>
            <mat-icon>science</mat-icon>
            Research Notebooks ({{ profile.posts.length }})
          </h3>
          
          @if (profile.posts.length > 0) {
            <mat-nav-list>
              @for (post of profile.posts; track post.id) {
                <a mat-list-item [routerLink]="['/posts', post.id]" class="post-item">
                  <mat-icon matListItemIcon>description</mat-icon>
                  <div matListItemTitle>{{ post.title }}</div>
                  <div matListItemLine>Published {{ post.published_at | date: 'mediumDate' }}</div>
                </a>
              }
            </mat-nav-list>
          } @else {
            <p class="empty-message">This user hasn't published any notebooks yet.</p>
          }
        </section>
      </div>
    }
  </section>
</div>
