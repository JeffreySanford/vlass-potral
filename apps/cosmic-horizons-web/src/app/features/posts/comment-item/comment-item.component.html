<div class="comment-container" [style.margin-left.px]="depth * 20">
  <div class="comment-card">
    <div class="comment-header">
      @if (comment.user?.username) {
        <a [routerLink]="['/profile', comment.user?.username]" class="username-link">
          <span class="username">{{ comment.user?.display_name || comment.user?.username || 'Anonymous' }}</span>
        </a>
      } @else {
        <span class="username">{{ comment.user?.display_name || comment.user?.username || 'Anonymous' }}</span>
      }
      <span class="timestamp">{{ comment.created_at | date: 'short' }}</span>
    </div>

    <div class="comment-body">
      {{ comment.content }}
    </div>

    <div class="comment-actions">
      @if (!comment.deleted_at) {
        @if (canReply) {
          <button mat-button color="primary" (click)="toggleReply()">
            Reply
          </button>
        }
        @if (canReport) {
          <button mat-button (click)="reportComment()">
            Report
          </button>
        }
        @if (canDelete) {
          <button mat-button color="warn" (click)="deleteComment()">
            Delete
          </button>
        }
        @if (canDeleteAny) {
          <button mat-button color="accent" (click)="hideComment()">
            Hide
          </button>
        }
      }
    </div>

    @if (showReplyForm) {
      <div class="reply-form">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Your reply</mat-label>
          <textarea matInput rows="3" [(ngModel)]="replyContent" [disabled]="submittingReply"></textarea>
        </mat-form-field>
        @if (error) {
          <div class="error">{{ error }}</div>
        }
        <div class="form-actions">
          <button mat-button (click)="toggleReply()" [disabled]="submittingReply">Cancel</button>
          <button mat-raised-button color="primary" (click)="submitReply()" [disabled]="!replyContent.trim() || submittingReply">
            Post Reply
          </button>
        </div>
      </div>
    }
  </div>

  @if (comment.replies && comment.replies.length > 0) {
    <div class="replies">
      @for (reply of comment.replies; track reply.id) {
        <app-comment-item
          [comment]="reply"
          [depth]="depth + 1"
          [canDeleteAny]="canDeleteAny"
          [isPostLocked]="isPostLocked"
          (deleted)="onChildDeleted($event)"
          (replied)="onChildReplied()"
        >
        </app-comment-item>
      }
    </div>
  }
</div>
