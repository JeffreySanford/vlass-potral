<div class="detail-page">
  <mat-toolbar color="primary" class="detail-toolbar">
    <span>Notebook Post</span>
    <span class="spacer"></span>
    <a mat-flat-button routerLink="/posts">Back to feed</a>
  </mat-toolbar>

  <section class="detail-shell">
    @if (loading) {
      <p>Loading post...</p>
    } @else if (!post) {
      <p>{{ statusMessage || 'Post unavailable.' }}</p>
    } @else {
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>{{ post.title }}</mat-card-title>
          <mat-card-subtitle>
            @if (post.user?.username) {
              <a [routerLink]="['/profile', post.user?.username]" class="author-link">
                {{ post.user?.display_name || post.user?.username || 'Unknown author' }}
              </a>
            } @else {
              <span class="author-link">{{ post.user?.display_name || post.user?.username || 'Unknown author' }}</span>
            }
            | {{ post.status }}
            @if (post.hidden_at) {
              | hidden
            }
            @if (post.locked_at) {
              | locked
            }
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <section class="share-panel">
            <span class="share-url">{{ post.id }}</span>
            <button mat-stroked-button type="button" (click)="copyShareLink()">Copy Share Link</button>
          </section>

          <section class="view-toggle">
            <button mat-stroked-button type="button" [disabled]="viewMode === 'formatted'" (click)="viewMode = 'formatted'">
              Formatted View
            </button>
            <button mat-stroked-button type="button" [disabled]="viewMode === 'raw'" (click)="viewMode = 'raw'">
              Raw Markdown
            </button>
          </section>

          @if (viewMode === 'raw') {
            <pre class="content">{{ post.content }}</pre>
          } @else {
            <div class="content formatted" [innerHTML]="formattedContent"></div>
          }
        </mat-card-content>
        <mat-card-actions>
          @if (post.status === 'draft') {
            <button mat-stroked-button type="button" [disabled]="publishing" (click)="publish()">
              @if (publishing) {
                Publishing...
              } @else {
                Publish
              }
            </button>
          }
          @if (canModerate) {
            <button mat-stroked-button type="button" [disabled]="moderating" (click)="toggleHidden()">
              {{ post.hidden_at ? 'Unhide' : 'Hide' }}
            </button>
            <button mat-stroked-button type="button" [disabled]="moderating" (click)="toggleLocked()">
              {{ post.locked_at ? 'Unlock' : 'Lock' }}
            </button>
          }
          <a mat-button routerLink="/view">Open Viewer</a>
        </mat-card-actions>
      </mat-card>

      <section class="comments-section">
        <h2 class="comments-title">Comments ({{ comments.length }})</h2>

        @if (!post.locked_at) {
          @if (isAuthenticated) {
            <div class="add-comment">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Add a comment...</mat-label>
                <textarea matInput rows="3" [(ngModel)]="newCommentContent" [disabled]="submittingComment"></textarea>
              </mat-form-field>
              <div class="form-actions">
                <button mat-raised-button color="primary" [disabled]="!newCommentContent.trim() || submittingComment" (click)="submitComment()">
                  {{ submittingComment ? 'Posting...' : 'Post Comment' }}
                </button>
              </div>
            </div>
          } @else {
            <div class="login-prompt">
              Please <a routerLink="/login">login</a> to join the conversation.
            </div>
          }
        } @else {
          <div class="locked-message">
            <mat-icon>lock</mat-icon> This post is locked. No new comments are allowed.
          </div>
        }

        @if (!loadingComments) {
          @if (comments.length > 0) {
            <div class="comments-list">
              @for (comment of comments; track comment.id) {
                <app-comment-item
                  [comment]="comment"
                  [canDeleteAny]="canModerate"
                  [isPostLocked]="!!post.locked_at"
                  (deleted)="onCommentDeleted()"
                  (replied)="onCommentReplied()"
                >
                </app-comment-item>
              }
            </div>
          } @else {
            <div class="empty-comments">
              No comments yet. Be the first to share your thoughts!
            </div>
          }
        } @else {
          <mat-spinner diameter="40"></mat-spinner>
        }
      </section>
    }

    @if (statusMessage) {
      <p class="status">{{ statusMessage }}</p>
    }
  </section>
</div>
