<div class="ephemeris-container">
  <mat-toolbar color="primary" class="app-toolbar">
    <mat-icon class="brand-icon">satellite_alt</mat-icon>
    <span class="brand">Cosmic Horizon</span>
    <span class="spacer"></span>
    @if (user.username) {
      <a mat-button routerLink="/profile">
        <mat-icon>account_circle</mat-icon> My Profile
      </a>
    }
    <button mat-flat-button color="warn" (click)="logout()">
      <mat-icon>logout</mat-icon> Logout
    </button>
  </mat-toolbar>

  <div class="content-wrapper">
    <section class="page-header">
      <h1>Scientific Ephemeris & Target Search</h1>
      <p class="subtitle">
        Search for celestial objects and calculate their positions at specified epochs using JPL Horizons data
      </p>
    </section>

    <mat-card class="search-card">
      <mat-card-header>
        <mat-card-title>Target Search</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        @if (error) {
          <div class="error-alert" role="alert" aria-live="polite">
            <mat-icon>error</mat-icon>
            <div class="error-content">
              <strong>Search Failed</strong>
              <p>{{ error }}</p>
            </div>
          </div>
        }

        <form [formGroup]="searchForm" (ngSubmit)="onSubmit()" class="search-form">
          <div class="form-row">
            <mat-form-field class="search-field">
              <mat-label>Target Name or Object ID</mat-label>
              <input
                matInput
                formControlName="target"
                placeholder="e.g., Mars, Earth, Pluto, or JPL ID"
                [attr.aria-invalid]="f['target'].invalid && submitted"
              />
              @if (f['target'].invalid && submitted) {
                <mat-error>Target name is required (minimum 2 characters)</mat-error>
              }
            </mat-form-field>

            <mat-form-field class="epoch-field">
              <mat-label>Epoch (ISO 8601)</mat-label>
              <input
                matInput
                formControlName="epoch"
                type="datetime-local"
                placeholder="e.g., 2026-02-13T12:00:00"
              />
              <mat-hint>Leave blank for current time</mat-hint>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="loading"
            >
              @if (loading) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                <mat-icon>search</mat-icon>
              }
              <span>Search</span>
            </button>

            @if (submitted && (result || error)) {
              <button
                mat-stroked-button
                type="button"
                (click)="clearSearch()"
                [disabled]="loading"
              >
                <mat-icon>clear</mat-icon>
                Clear
              </button>
            }
          </div>
        </form>

        @if (result) {
          <div class="results-section">
            <h2>Search Results</h2>

            <mat-card class="result-card">
              <mat-card-content>
                <div class="result-grid">
                  <div class="result-item">
                    <span class="label">Target</span>
                    <span class="value">{{ result.target }}</span>
                  </div>

                  <div class="result-item">
                    <span class="label">Epoch (UTC)</span>
                    <span class="value">{{ result.epoch }}</span>
                  </div>

                  <div class="result-item">
                    <span class="label">Right Ascension (RA)</span>
                    <span class="value">{{ result.ra | number: '1.6-6' }}°</span>
                  </div>

                  <div class="result-item">
                    <span class="label">Declination (Dec)</span>
                    <span class="value">{{ result.dec | number: '1.6-6' }}°</span>
                  </div>

                  <div class="result-item">
                    <span class="label">Accuracy</span>
                    <span class="value">{{ result.accuracy_arcsec | number: '1.3-3' }}&quot;</span>
                  </div>

                  <div class="result-item">
                    <span class="label">Object Type</span>
                    <span class="value">{{ result.object_type | titlecase }}</span>
                  </div>

                  <div class="result-item">
                    <span class="label">Data Source</span>
                    <span class="value">{{ result.source | titlecase }}</span>
                  </div>
                </div>

                <div class="result-note">
                  <p>
                    <strong>Data Source:</strong> {{ result.source | titlecase }}
                    <br />
                    <strong>Accuracy:</strong> ±{{ result.accuracy_arcsec | number: '1.2-2' }} arcseconds
                  </p>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <mat-card class="info-card">
      <mat-card-header>
        <mat-card-title>About Ephemeris Data</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p>
          Ephemeris data provides precise positions of celestial objects at specific times. This tool queries the astronomy-engine library to compute accurate coordinates for planets, moons, and other solar system bodies.
        </p>
        <ul>
          <li><strong>Right Ascension (RA):</strong> Angular position east-west on the celestial sphere (0-360°)</li>
          <li><strong>Declination (Dec):</strong> Angular position north-south on the celestial sphere (-90° to +90°)</li>
          <li><strong>Accuracy:</strong> Typical precision of the calculation in arcseconds</li>
          <li><strong>Object Type:</strong> Classification of the celestial object (Planet, Satellite, or Asteroid)</li>
          <li><strong>Data Source:</strong> Whether the result was calculated fresh or retrieved from cache</li>
        </ul>
        <p>
          For more information, visit
          <a href="https://ssd.jpl.nasa.gov/horizons/" target="_blank" rel="noopener noreferrer">JPL Horizons</a>
        </p>
      </mat-card-content>
    </mat-card>
  </div>
</div>
