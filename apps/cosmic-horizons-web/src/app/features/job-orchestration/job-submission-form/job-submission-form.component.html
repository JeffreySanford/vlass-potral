<!-- eslint-disable @angular-eslint/template/prefer-control-flow, @angular-eslint/template/label-has-associated-control -->
<div class="job-submission-panel">
  <div class="panel-header">
    <h2>Submit New Job</h2>
    <p class="subtitle">Launch autonomous agent reprocessing workflows</p>
  </div>

  <form [formGroup]="submissionForm" (ngSubmit)="onSubmit()" class="submission-form">
    <!-- Agent Selection -->
    <div class="form-section">
      <label class="form-label">Select Agent</label>
      <mat-select formControlName="agentId" class="agent-select">
        <mat-option *ngFor="let agent of (agents$ | async)" [value]="agent.id">
          <div class="agent-option">
            <div class="agent-name">{{ agent.name }}</div>
            <div class="agent-description">{{ agent.description }}</div>
          </div>
        </mat-option>
      </mat-select>
    </div>

    <!-- Job Name -->
    <div class="form-section">
      <label class="form-label">Job Name</label>
      <input
        matInput
        type="text"
        formControlName="jobName"
        placeholder="e.g., ngVLA Calibration Run 2"
        class="text-input"
      />
    </div>

    <!-- Resource Allocation -->
    <div class="form-section">
      <label class="form-label">Resource Allocation</label>
      <div class="resource-grid">
        <div class="resource-input">
          <span class="resource-label">CPU Cores</span>
          <input
            type="number"
            min="1"
            max="128"
            matInput
            placeholder="1-128"
            formControlName="cpuCores"
          />
          <div class="resource-value">{{ submissionForm.get('cpuCores')?.value }} cores</div>
        </div>

        <div class="resource-input">
          <span class="resource-label">Memory (GB)</span>
          <input
            type="number"
            min="8"
            max="512"
            step="8"
            matInput
            placeholder="8-512"
            formControlName="memoryGb"
          />
          <div class="resource-value">{{ submissionForm.get('memoryGb')?.value }} GB</div>
        </div>

        <div class="resource-input">
          <span class="resource-label">GPU Count</span>
          <input
            type="number"
            min="0"
            max="8"
            matInput
            placeholder="0-8"
            formControlName="gpuCount"
          />
          <div class="resource-value">{{ submissionForm.get('gpuCount')?.value }}</div>
        </div>
      </div>
    </div>

    <!-- Data Input -->
    <div class="form-section">
      <label class="form-label">Data Input Path</label>
      <input
        matInput
        type="text"
        formControlName="dataPath"
        placeholder="e.g., /data/ngvla/observations/2026-02-15"
        class="text-input"
      />
      <div class="hint">Path to observation data on TACC storage</div>
    </div>

    <!-- Parameters (key-value) -->
    <div class="form-section">
      <label class="form-label">Agent Parameters (Optional)</label>
      <div class="parameters-list">
        <div *ngFor="let param of parameterFields; let i = index" class="parameter-input">
          <input type="text" placeholder="Key" [(ngModel)]="param.key" [ngModelOptions]="{standalone: true}" />
          <input type="text" placeholder="Value" [(ngModel)]="param.value" [ngModelOptions]="{standalone: true}" />
          <button type="button" (click)="removeParameter(i)" class="remove-btn">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <button type="button" (click)="addParameter()" class="add-param-btn">
          <mat-icon>add</mat-icon>
          Add Parameter
        </button>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="form-actions">
      <button
        type="submit"
        [disabled]="submissionForm.invalid || isSubmitting"
        class="submit-btn"
        mat-raised-button
      >
        <mat-icon *ngIf="!isSubmitting">send</mat-icon>
        <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
        {{ isSubmitting ? 'Submitting...' : 'Submit Job' }}
      </button>
    </div>

    <div *ngIf="submitError" class="error-message">
      <mat-icon>error</mat-icon>
      {{ submitError }}
    </div>
  </form>
</div>
