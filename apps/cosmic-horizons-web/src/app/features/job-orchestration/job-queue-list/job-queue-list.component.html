<!-- eslint-disable @angular-eslint/template/prefer-control-flow -->
<div class="job-queue-panel">
  <div class="panel-header">
    <h2>Job Queue & History</h2>
    <div class="header-controls">
      <div class="filter-group">
        <button
          *ngFor="let status of statusFilters"
          [class.active]="selectedStatus === status"
          (click)="selectedStatus = status"
          class="filter-btn"
        >
          {{ status | titlecase }}
        </button>
      </div>
    </div>
  </div>

  <div class="jobs-list" *ngIf="(filteredJobs$ | async) as jobs">
    <div *ngIf="jobs.length === 0" class="empty-state">
      <mat-icon class="empty-icon">inbox</mat-icon>
      <p>No jobs {{ selectedStatus !== 'all' ? 'with status ' + selectedStatus : 'yet' }}</p>
    </div>

    <div *ngFor="let job of jobs" class="job-card" [ngClass]="job.status">
      <div class="job-header">
        <div class="job-title">
          <mat-icon class="status-icon" [style.color]="getStatusColor(job.status)">
            {{ getStatusIcon(job.status) }}
          </mat-icon>
          <div class="title-group">
            <h3>{{ job.name }}</h3>
            <span class="job-id">{{ job.id }}</span>
          </div>
        </div>
        <span class="job-status" [style.color]="getStatusColor(job.status)">
          {{ job.status | uppercase }}
        </span>
      </div>

      <div class="job-meta">
        <div class="meta-item">
          <span class="meta-label">Agent</span>
          <span class="meta-value">{{ job.agentName }}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Created</span>
          <span class="meta-value">{{ job.createdAt | date: 'short' }}</span>
        </div>
        <div class="meta-item" *ngIf="job.startedAt">
          <span class="meta-label">Started</span>
          <span class="meta-value">{{ job.startedAt | date: 'short' }}</span>
        </div>
      </div>

      <!-- Progress Bar -->
      <div *ngIf="job.status === 'running' || job.status === 'queued'" class="progress-section">
        <div class="progress-header">
          <span>Progress</span>
          <span class="progress-percent">{{ job.progress }}%</span>
        </div>
        <mat-progress-bar [value]="job.progress" mode="determinate"></mat-progress-bar>
        <div *ngIf="job.estimatedTimeRemaining" class="time-remaining">
          Estimated: {{ formatTimeRemaining(job.estimatedTimeRemaining) }}
        </div>
      </div>

      <!-- Completed/Failed State -->
      <div *ngIf="job.status === 'completed'" class="completion-info">
        <div class="completion-time">
          <span class="label">Duration:</span>
          <span class="value">{{ calculateDuration(job) }}</span>
        </div>
        <button mat-stroked-button class="download-btn" *ngIf="job.outputPath">
          <mat-icon>download</mat-icon>
          Download Results
        </button>
      </div>

      <div *ngIf="job.status === 'failed'" class="error-info">
        <p class="error-message">{{ job.errorMessage || 'Job failed. Check logs for details.' }}</p>
      </div>

      <!-- Actions -->
      <div class="job-actions">
        <button
          mat-icon-button
          matTooltip="View Details"
          (click)="onJobDetail(job.id)"
        >
          <mat-icon>info</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Cancel Job"
          *ngIf="job.status === 'queued' || job.status === 'running'"
          (click)="onCancelJob(job.id)"
        >
          <mat-icon>cancel</mat-icon>
        </button>
        <button mat-icon-button matTooltip="View Logs">
          <mat-icon>description</mat-icon>
        </button>
      </div>
    </div>
  </div>
</div>
